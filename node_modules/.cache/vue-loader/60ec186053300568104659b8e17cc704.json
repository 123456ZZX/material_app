{"remainingRequest":"D:\\Code\\Project\\WL\\xasw-mobile\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\Code\\Project\\WL\\xasw-mobile\\src\\views\\PumpStationInspection\\components\\InspectionSubmit.vue?vue&type=style&index=0&id=1088fd8c&scoped=true&lang=less","dependencies":[{"path":"D:\\Code\\Project\\WL\\xasw-mobile\\src\\views\\PumpStationInspection\\components\\InspectionSubmit.vue","mtime":1708928163414},{"path":"D:\\Code\\Project\\WL\\xasw-mobile\\node_modules\\css-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\Code\\Project\\WL\\xasw-mobile\\node_modules\\vue-loader\\lib\\loaders\\stylePostLoader.js","mtime":499162500000},{"path":"D:\\Code\\Project\\WL\\xasw-mobile\\node_modules\\postcss-loader\\src\\index.js","mtime":499162500000},{"path":"D:\\Code\\Project\\WL\\xasw-mobile\\node_modules\\less-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\Code\\Project\\WL\\xasw-mobile\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\Code\\Project\\WL\\xasw-mobile\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:DQouaW5zcGVjdGlvbi1zdWJtaXQgew0KICB3aWR0aDogY2FsYygxMDAlIC0gMTUwcHgpOw0KICBwb3NpdGlvbjogZml4ZWQ7DQogIGJvdHRvbTogMDsNCiAgZGlzcGxheTogZmxleDsNCiAganVzdGlmeS1jb250ZW50OiBzcGFjZS1hcm91bmQ7DQogIGFsaWduLWl0ZW1zOiBjZW50ZXI7DQogIGhlaWdodDogMTEycHg7DQogIHBhZGRpbmc6IDEwcHggMzBweCAxMHB4IDEyMHB4Ow0KICBiYWNrZ3JvdW5kLWNvbG9yOiAjZmZmOw0KDQogIC5pbnNwZWN0aW9uLW1hcCB7DQogICAgZGlzcGxheTogZmxleDsNCiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsNCiAgICBhbGlnbi1pdGVtczogY2VudGVyOw0KICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsNCiAgICBsZWZ0OiA0MHB4Ow0KICAgIHdpZHRoOiA0MHB4Ow0KICAgIGhlaWdodDogNDBweDsNCg0KICAgIC5pbnNwZWN0aW9uLWljb24gew0KICAgICAgd2lkdGg6IDEwMCU7DQogICAgICBoZWlnaHQ6IDEwMCU7DQogICAgfQ0KICB9DQoNCiAgLmluc3BlY3Rpb24tYnRuIHsNCiAgICB3aWR0aDogMjg4cHg7DQogICAgaGVpZ2h0OiA4OHB4Ow0KICAgIGJvcmRlci1yYWRpdXM6IDQ0cHg7DQogIH0NCg0KICAuaW5zcGVjdGlvbi1idG4tb25lIHsNCiAgICB3aWR0aDogMTAwJTsNCiAgfQ0KfQ0K"},{"version":3,"sources":["InspectionSubmit.vue"],"names":[],"mappings":";AA0SA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA","file":"InspectionSubmit.vue","sourceRoot":"src/views/PumpStationInspection/components","sourcesContent":["<template>\r\n  <div class=\"inspection-submit\">\r\n    <div class=\"inspection-map\">\r\n      <img\r\n        v-if=\"modelType === 'list'\"\r\n        @click=\"modelTypeChange('map')\"\r\n        src=\"@/assets/img/pump/inspection-map.png\"\r\n        alt=\"\"\r\n        class=\"inspection-icon\"\r\n      />\r\n      <img\r\n        v-if=\"modelType === 'map'\"\r\n        @click=\"modelTypeChange('list')\"\r\n        src=\"@/assets/img/pump/inspection-list.png\"\r\n        alt=\"\"\r\n        class=\"inspection-icon\"\r\n      />\r\n    </div>\r\n\r\n    <fm-button\r\n      type=\"success\"\r\n      class=\"inspection-btn inspection-btn-one\"\r\n      v-if=\"PatrolData && PatrolData.patrolStatus === 1\"\r\n      @click=\"startInspection(2)\"\r\n      >开始巡检</fm-button\r\n    >\r\n    <fm-button\r\n      type=\"success\"\r\n      class=\"inspection-btn\"\r\n      v-if=\"PatrolData && PatrolData.patrolStatus === 2 && !firstConfig && finishConfig\"\r\n      @click=\"submit(3)\"\r\n      >完成巡检</fm-button\r\n    >\r\n    <fm-button\r\n      type=\"warning\"\r\n      class=\"inspection-btn\"\r\n      v-if=\"PatrolData && PatrolData.patrolStatus === 2 && !firstConfig && !finishConfig\"\r\n      @click=\"terminatedInspection(4)\"\r\n      >终止巡检</fm-button\r\n    >\r\n    <fm-button\r\n      type=\"primary\"\r\n      class=\"inspection-btn\"\r\n      v-if=\"PatrolData && PatrolData.patrolStatus === 2 && !firstConfig && !finishConfig\"\r\n      @click=\"stopInspection()\"\r\n      >暂停巡检</fm-button\r\n    >\r\n    <fm-button\r\n      type=\"primary\"\r\n      class=\"inspection-btn inspection-btn-one\"\r\n      v-if=\"PatrolData && PatrolData.patrolStatus === 2 && firstConfig\"\r\n      @click=\"goInspection()\"\r\n      >继续巡检</fm-button\r\n    >\r\n\r\n    <fm-dialog\r\n      :visible.sync=\"submitShow\"\r\n      title=\"巡检任务提交\"\r\n      @confirm=\"onConfirm\"\r\n      show-cancel-button\r\n      width=\"331\"\r\n    >\r\n      <inspection-submit-card :PatrolData=\"submitData\"  @getActualPerson='getActualPerson' />\r\n    </fm-dialog>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport InspectionSubmitCard from './InspectionSubmitCard.vue'\r\nimport { patrolEdit, uploadTrackList } from '../api'\r\nexport default {\r\n  components: { InspectionSubmitCard },\r\n  props: {\r\n    //巡检状态(1:待巡检，2:巡检中，3:已完成 ，4:已终止)(手机端)\r\n    PatrolData: {\r\n      type: Object,\r\n      default: () => {},\r\n    },\r\n    modelType: {\r\n      type: String,\r\n      default: 'list',\r\n    },\r\n  },\r\n  watch: {\r\n    PatrolData: {\r\n      handler: function () {\r\n        this.isFinishConfig()\r\n      },\r\n      deep: true,\r\n      immediate: true,\r\n    },\r\n  },\r\n  data() {\r\n    return {\r\n      submitData: null,\r\n      firstConfig: true, //是否为第一次进入\r\n      finishConfig: false, //巡检点是否巡检完毕\r\n      submitShow: false, //提交弹框\r\n      disabled: true,\r\n    }\r\n  },\r\n\r\n  mounted() {\r\n    this.setFirstConfig()\r\n  },\r\n  beforeDestroy() {\r\n    this.stopRequestLocations()\r\n  },\r\n\r\n  methods: {\r\n    //内容变化\r\n    //list列表，map地图\r\n    modelTypeChange(type) {\r\n      if (this.firstConfig && this.PatrolData.patrolStatus === 2) return\r\n      this.$emit('modelTypeChange', type)\r\n\r\n      this.stopRequestLocations()\r\n      if (type === 'list') this.requestSingleLocation(false)\r\n    },\r\n\r\n    //判断是否为第一次进入\r\n    setFirstConfig() {\r\n      let { firstConfig } = this.$store.state.pump.urlQuery\r\n\r\n      if (firstConfig === false) {\r\n        this.firstConfig = false\r\n        this.$emit('isDisabled', false)\r\n        console.log('isDisabled', false)\r\n\r\n        this.requestSingleLocation(this.firstConfig)\r\n      } else {\r\n        this.firstConfig = true\r\n      }\r\n    },\r\n\r\n    //巡检点是否巡检完毕\r\n    isFinishConfig() {\r\n      let config = this.PatrolData?.patrolPointResultList?.every((item) => {\r\n        return item.patrolStatus === '已巡'\r\n      })\r\n      this.finishConfig = config\r\n    },\r\n\r\n    //继续巡检\r\n    goInspection() {\r\n      this.firstConfig = false\r\n      this.$emit('isDisabled', false)\r\n\r\n      this.requestSingleLocation(true)\r\n    },\r\n\r\n    //开始巡检\r\n    async startInspection(type) {\r\n      let query = {\r\n        id: this.$store.state.pump.urlQuery.taskId,\r\n        patrolStatus: type ? type : this.PatrolData && this.PatrolData.patrolStatus,\r\n        patrolStartTime: this.$dayjs().format('YYYY-MM-DD HH:mm:ss'),\r\n        patrolPointResultList: this.PatrolData && this.PatrolData.patrolPointResultList,\r\n      }\r\n\r\n      this.$emit('isDisabled', false)\r\n\r\n      this.requestSingleLocation(true)\r\n\r\n      const res = await patrolEdit(query)\r\n      this.$parent.getPatrol()\r\n      this.firstConfig = false\r\n      this.$router.push({\r\n        path: '/pump/inspection',\r\n        query: {\r\n          taskId: this.$store.state.pump.urlQuery.taskId,\r\n          firstConfig: 'false',\r\n        },\r\n      })\r\n    },\r\n\r\n    //暂停巡检\r\n    stopInspection() {\r\n      this.$dialog\r\n        .confirm({\r\n          title: '暂停巡检',\r\n          message: '暂停巡检将提交未提交的巡检点和隐患数据！',\r\n        })\r\n        .then(async () => {\r\n          await this.isUnsubmitted()\r\n\r\n          this.$router.replace('/pump/inspectionManage')\r\n        })\r\n        .catch((error) => {\r\n          console.log(error)\r\n        })\r\n    },\r\n\r\n    //终止巡检\r\n    async terminatedInspection() {\r\n      this.$store.commit('setUrlQuery', {\r\n        taskId: this.$store.state.pump.urlQuery.taskId,\r\n      })\r\n      this.$router.push(`/pump/terminated-task`)\r\n    },\r\n\r\n    //检查是否有未提交项,并提交\r\n    async isUnsubmitted() {\r\n      this.submitData = JSON.parse(JSON.stringify(this.PatrolData))\r\n\r\n      let storageItemDataList = JSON.parse(this.$storage.get('pump-storageItemDataList'))\r\n      this.submitData.patrolPointResultList?.forEach((item, index) => {\r\n        storageItemDataList?.forEach((data, i) => {\r\n          item.id === data.id\r\n            ? (this.submitData.patrolPointResultList[index] = storageItemDataList[i])\r\n            : null\r\n        })\r\n      })\r\n\r\n      this.$storage.remove('pump-storageItemDataList')\r\n      const res = await patrolEdit(this.submitData)\r\n    },\r\n\r\n    //开始巡检\r\n    requestSingleLocation(isFirst) {\r\n      console.log(isFirst, '记录巡检')\r\n      if (typeof yuanchu != 'undefined') {\r\n        yuanchu.locationAMap.requestSingleLocation(\r\n          ['1'],\r\n          (res) => {\r\n            let { latitude, longitude } = res\r\n            let path\r\n            if (isFirst) {\r\n              path =\r\n                this.PatrolData && this.PatrolData.patrolPointTrackList\r\n                  ? this.PatrolData.patrolPointTrackList\r\n                  : []\r\n              console.log(path)\r\n            } else {\r\n              path = JSON.parse(JSON.stringify(this.$store.state.pump.pumpPath))\r\n            }\r\n\r\n            path.push({\r\n              lat: latitude,\r\n              lon: longitude,\r\n            })\r\n            this.$store.commit('setPumpPath', path)\r\n\r\n            console.log(this.$store.state.pump.pumpPath)\r\n          },\r\n          (err) => {\r\n            console.log('err=', err)\r\n          }\r\n        )\r\n      }\r\n    },\r\n\r\n    //结束定位\r\n    stopRequestLocations() {\r\n      console.log('结束巡检')\r\n      if (typeof yuanchu != 'undefined') {\r\n        yuanchu.locationAMap.stopRequestLocations()\r\n      }\r\n    },\r\n\r\n    //完成巡检提交\r\n    async submit(type) {\r\n      this.submitData = JSON.parse(JSON.stringify(this.PatrolData))\r\n      this.submitData.patrolStatus = type\r\n      this.submitData.patrolEndTime = this.$dayjs().format('YYYY-MM-DD HH:mm:ss')\r\n      this.submitData.submitTime = this.$dayjs().format('YYYY-MM-DD HH:mm:ss')\r\n      this.submitShow = true\r\n    },\r\n\r\n    //获取实际巡检人\r\n    getActualPerson(actualPerson) {\r\n      this.$set(this.submitData,'actualPerson',actualPerson)\r\n    },\r\n\r\n    //任务提交确认\r\n    async onConfirm() {\r\n      try {\r\n        let query = {\r\n          patrolTaskId: this.$store.state.pump.urlQuery.taskId,\r\n          trackDTOS: this.$store.state.pump.pumpPath,\r\n        }\r\n\r\n        const path = await uploadTrackList(query)\r\n        this.$store.commit('setPumpPath', [])\r\n\r\n        const res = await patrolEdit(this.submitData)\r\n        this.$parent.getPatrol()\r\n        this.firstConfig = false\r\n        this.$router.replace('/pump/inspectionManage')\r\n      } catch (error) {\r\n        console.log(error)\r\n      }\r\n    },\r\n  },\r\n}\r\n</script>\r\n\r\n<style scoped lang=\"less\">\r\n.inspection-submit {\r\n  width: calc(100% - 150px);\r\n  position: fixed;\r\n  bottom: 0;\r\n  display: flex;\r\n  justify-content: space-around;\r\n  align-items: center;\r\n  height: 112px;\r\n  padding: 10px 30px 10px 120px;\r\n  background-color: #fff;\r\n\r\n  .inspection-map {\r\n    display: flex;\r\n    justify-content: center;\r\n    align-items: center;\r\n    position: absolute;\r\n    left: 40px;\r\n    width: 40px;\r\n    height: 40px;\r\n\r\n    .inspection-icon {\r\n      width: 100%;\r\n      height: 100%;\r\n    }\r\n  }\r\n\r\n  .inspection-btn {\r\n    width: 288px;\r\n    height: 88px;\r\n    border-radius: 44px;\r\n  }\r\n\r\n  .inspection-btn-one {\r\n    width: 100%;\r\n  }\r\n}\r\n</style>\r\n"]}]}