{"remainingRequest":"E:\\ty_project\\xasw-yy\\revenue\\xasw-mobile\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!E:\\ty_project\\xasw-yy\\revenue\\xasw-mobile\\src\\views\\PumpStationInspection\\components\\TerminatedTask.vue?vue&type=style&index=0&id=4fba5d28&scoped=true&lang=less","dependencies":[{"path":"E:\\ty_project\\xasw-yy\\revenue\\xasw-mobile\\src\\views\\PumpStationInspection\\components\\TerminatedTask.vue","mtime":1708928163416},{"path":"E:\\ty_project\\xasw-yy\\revenue\\xasw-mobile\\node_modules\\css-loader\\dist\\cjs.js","mtime":499162500000},{"path":"E:\\ty_project\\xasw-yy\\revenue\\xasw-mobile\\node_modules\\vue-loader\\lib\\loaders\\stylePostLoader.js","mtime":499162500000},{"path":"E:\\ty_project\\xasw-yy\\revenue\\xasw-mobile\\node_modules\\postcss-loader\\src\\index.js","mtime":499162500000},{"path":"E:\\ty_project\\xasw-yy\\revenue\\xasw-mobile\\node_modules\\less-loader\\dist\\cjs.js","mtime":499162500000},{"path":"E:\\ty_project\\xasw-yy\\revenue\\xasw-mobile\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"E:\\ty_project\\xasw-yy\\revenue\\xasw-mobile\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:DQoudGVybWluYXRlZC10YXNrIHsNCiAgaGVpZ2h0OiAxMDAlOw0KICBiYWNrZ3JvdW5kOiAjZjVmN2Y5Ow0KDQogIC50ZXJtaW5hdGVkLXRhc2stY29udGVudCB7DQogICAgcGFkZGluZzogMCAzMHB4Ow0KICB9DQoNCiAgLnRlcm1pbmF0ZWQtdGFzay1yZW1hcmsgew0KICAgIGRpc3BsYXk6IGZsZXg7DQogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsNCiAgICBoZWlnaHQ6IDc0cHg7DQogICAgZm9udC1zaXplOiAyOHB4Ow0KICAgIGNvbG9yOiAjOTk5Ow0KICB9DQoNCiAgLmZpZWxkIHsNCiAgICBoZWlnaHQ6IGF1dG8gIWltcG9ydGFudDsNCiAgICBtaW4taGVpZ2h0OiAzMDBweDsNCiAgICBtYXgtaGVpZ2h0OiA3MHZoOw0KICAgIG92ZXJmbG93OiBzY3JvbGw7DQogICAgYm9yZGVyLXJhZGl1czogMTZweCAhaW1wb3J0YW50Ow0KICB9DQoNCiAgLnRlcm1pbmF0ZWQtdGFzay1zdWJtaXQgew0KICAgIHdpZHRoOiAxMDAlOw0KICAgIGhlaWdodDogODhweDsNCiAgICBib3JkZXItcmFkaXVzOiA0NHB4Ow0KICAgIG1hcmdpbi10b3A6IDYwcHg7DQogIH0NCn0NCg=="},{"version":3,"sources":["TerminatedTask.vue"],"names":[],"mappings":";AAyKA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA","file":"TerminatedTask.vue","sourceRoot":"src/views/PumpStationInspection/components","sourcesContent":["<template>\r\n  <div class=\"terminated-task\">\r\n    <fm-nav-bar title=\"任务终止\" left-arrow @click-left=\"goTo()\" />\r\n    <div class=\"terminated-task-content\">\r\n      <div class=\"terminated-task-remark\">任务终止需要填写终止原因</div>\r\n\r\n      <fm-field\r\n        class=\"field\"\r\n        v-model=\"reason\"\r\n        label=\"终止原因\"\r\n        autosize\r\n        maxlength=\"500\"\r\n        show-word-limit\r\n        type=\"textarea\"\r\n        placeholder=\"请填写终止原因\"\r\n      />\r\n\r\n      <fm-button type=\"primary\" class=\"terminated-task-submit\" @click=\"submit()\">提交</fm-button>\r\n      <fm-dialog\r\n        :visible.sync=\"show\"\r\n        title=\"巡检任务提交\"\r\n        @confirm=\"onConfirm\"\r\n        show-cancel-button\r\n        width=\"331\"\r\n      >\r\n        <inspection-submit-card :PatrolData=\"PatrolData\"  :reason=\"reason\" @getActualPerson='getActualPerson' />\r\n      </fm-dialog>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport InspectionSubmitCard from './InspectionSubmitCard.vue'\r\nimport { patrol, patrolEdit, uploadTrackList } from '../api'\r\nexport default {\r\n  components: { InspectionSubmitCard },\r\n  data() {\r\n    return {\r\n      reason: '',\r\n      show: false,\r\n      PatrolData: null,\r\n      patrolPointResultList: [],\r\n    }\r\n  },\r\n\r\n  created() {\r\n    this.getPatrol()\r\n  },\r\n  beforeDestroy() {\r\n    this.$store.commit('setUrlQuery', {\r\n      taskId: this.$store.state.pump.urlQuery.taskId,\r\n      firstConfig: false,\r\n    })\r\n\r\n    this.stopRequestLocations()\r\n  },\r\n\r\n  methods: {\r\n    //获取用户巡检点\r\n    async getPatrol() {\r\n      let { taskId } = this.$store.state.pump.urlQuery\r\n      const {\r\n        data,\r\n        data: { patrolPointResultList },\r\n      } = await patrol(taskId)\r\n      this.PatrolData = data\r\n      this.patrolPointResultList = patrolPointResultList\r\n\r\n      this.requestSingleLocation()\r\n    },\r\n\r\n    //开始巡检\r\n    requestSingleLocation() {\r\n      if (typeof yuanchu != 'undefined') {\r\n        yuanchu.locationAMap.requestSingleLocation(\r\n          ['1'],\r\n          (res) => {\r\n            let { latitude, longitude } = res\r\n            let path = JSON.parse(JSON.stringify(this.$store.state.pump.pumpPath))\r\n            path.push({\r\n              lat: latitude,\r\n              lon: longitude,\r\n            })\r\n            this.$store.commit('setPumpPath', path)\r\n\r\n            console.log(this.$store.state.pump.pumpPath)\r\n          },\r\n          (err) => {\r\n            console.log('err=', err)\r\n          }\r\n        )\r\n      }\r\n    },\r\n\r\n    //结束巡检\r\n    stopRequestLocations() {\r\n      if (typeof yuanchu != 'undefined') {\r\n        yuanchu.locationAMap.stopRequestLocations()\r\n      }\r\n    },\r\n\r\n    //点击提交按钮\r\n    submit() {\r\n      if (this.reason === '') {\r\n        this.$toast('请填写终止原因')\r\n        return\r\n      }\r\n\r\n      this.isUnsubmitted()\r\n\r\n      this.PatrolData = {\r\n        ...this.PatrolData,\r\n        id: this.$store.state.pump.urlQuery.taskId,\r\n        patrolEndTime: this.$dayjs().format('YYYY-MM-DD HH:mm:ss'),\r\n        submitTime: this.$dayjs().format('YYYY-MM-DD HH:mm:ss'),\r\n        patrolStatus: 4,\r\n        endReason: this.reason,\r\n        patrolPointResultList: this.patrolPointResultList,\r\n      }\r\n\r\n      this.show = true\r\n    },\r\n\r\n    //检查是否有未提交项,并提交\r\n    async isUnsubmitted() {\r\n      let storageItemDataList = JSON.parse(this.$storage.get('pump-storageItemDataList'))\r\n      this.patrolPointResultList?.forEach((item, index) => {\r\n        storageItemDataList?.forEach((data, i) => {\r\n          item.id === data.id ? (this.patrolPointResultList[index] = storageItemDataList[i]) : null\r\n        })\r\n      })\r\n\r\n      this.$storage.remove('pump-storageItemDataList')\r\n    },\r\n\r\n    //获取实际巡检人\r\n    getActualPerson(actualPerson) {\r\n      this.$set(this.PatrolData,'actualPerson',actualPerson)\r\n    },\r\n\r\n    //提交终止任务\r\n    async onConfirm() {\r\n      try {\r\n        let query = {\r\n          patrolTaskId: this.$store.state.pump.urlQuery.taskId,\r\n          trackDTOS: this.$store.state.pump.pumpPath,\r\n        }\r\n\r\n        const path = await uploadTrackList(query)\r\n        this.$store.commit('setPumpPath', [])\r\n\r\n        const res = await patrolEdit(this.PatrolData)\r\n        this.$router.replace('/pump/inspectionManage')\r\n      } catch (error) {\r\n        console.log(error)\r\n      }\r\n    },\r\n\r\n    //返回列表页\r\n    goTo() {\r\n      this.$router.replace({\r\n        path: '/pump/inspection',\r\n      })\r\n    },\r\n  },\r\n}\r\n</script>\r\n\r\n<style scoped lang=\"less\">\r\n.terminated-task {\r\n  height: 100%;\r\n  background: #f5f7f9;\r\n\r\n  .terminated-task-content {\r\n    padding: 0 30px;\r\n  }\r\n\r\n  .terminated-task-remark {\r\n    display: flex;\r\n    align-items: center;\r\n    height: 74px;\r\n    font-size: 28px;\r\n    color: #999;\r\n  }\r\n\r\n  .field {\r\n    height: auto !important;\r\n    min-height: 300px;\r\n    max-height: 70vh;\r\n    overflow: scroll;\r\n    border-radius: 16px !important;\r\n  }\r\n\r\n  .terminated-task-submit {\r\n    width: 100%;\r\n    height: 88px;\r\n    border-radius: 44px;\r\n    margin-top: 60px;\r\n  }\r\n}\r\n</style>\r\n"]}]}